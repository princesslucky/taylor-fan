import streamlit as st
import requests
from datetime import datetime

# --- íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ê²° ì„¤ì • ---
FIREBASE_URL = "https://taylorswift-3836d-default-rtdb.firebaseio.com/"

st.set_page_config(page_title="Swiftie Critics", layout="centered")

# --- 1. ì…ì¥ (ë‹‰ë„¤ì„ ì…ë ¥) ---
if 'user_name' not in st.session_state:
    st.title("ğŸ¹ Swiftie Critics")
    st.subheader("í…Œì¼ëŸ¬ë¥¼ ì‚¬ë‘í•˜ëŠ” ìŠ¤ìœ„í”„í‹°ë¼ë©´?")
    name = st.text_input("ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì‚¬ìš©í•  ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”:")
    if st.button("ì…ì¥í•˜ê¸°"):
        if name:
            st.session_state.user_name = name
            st.rerun()
        else:
            st.warning("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    st.stop()

# --- 2. ë©”ì¸ í˜ì´ì§€ ---
st.title("ğŸ¹ Swiftie Critics")
st.write(f"**{st.session_state.user_name}**ë‹˜, í…Œì¼ëŸ¬ì˜ ìŒì•… ì„¸ê³„ë¥¼ í•¨ê»˜ ê¸°ë¡í•´ë´ìš”.")

# ì•¨ë²” ë¦¬ìŠ¤íŠ¸
albums = {
    "Taylor Swift (2006)": "https://upload.wikimedia.org/wikipedia/en/b/b7/Taylor_Swift_-_Taylor_Swift.png",
    "Fearless (Taylor's Version)": "https://upload.wikimedia.org/wikipedia/en/f/f2/Taylor_Swift_-_Fearless.png",
    "Speak Now (Taylor's Version)": "https://upload.wikimedia.org/wikipedia/en/f/f6/Taylor_Swift_-_Speak_Now_cover.png",
    "Red (Taylor's Version)": "https://upload.wikimedia.org/wikipedia/en/4/47/Taylor_Swift_-_Red_%28Taylor%27s_Version%29.png",
    "1989 (Taylor's Version)": "https://upload.wikimedia.org/wikipedia/en/d/d5/Taylor_Swift_-_1989_%28Taylor%27s_Version%29.png",
    "reputation": "https://upload.wikimedia.org/wikipedia/en/f/f2/Taylor_Swift_-_Reputation.png",
    "Lover": "https://upload.wikimedia.org/wikipedia/en/c/cd/Taylor_Swift_-_Lover.png",
    "folklore": "https://upload.wikimedia.org/wikipedia/en/f/f8/Taylor_Swift_-_Folklore.png",
    "evermore": "https://upload.wikimedia.org/wikipedia/en/0/0a/Taylor_Swift_-_Evermore.png",
    "Midnights": "https://upload.wikimedia.org/wikipedia/en/9/9f/Taylor_Swift_-_Midnights.png",
    "The Tortured Poets Department": "https://upload.wikimedia.org/wikipedia/en/5/52/The_Tortured_Poets_Department_-_Taylor_Swift.png"
}

# ë¹ˆ ê´‘ê³ ì¹¸
def draw_empty_space():
    st.components.v1.html("""<div style="height: 90px; background-color: white;"></div>""", height=90)

# ì•¨ë²” ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
for name, img in albums.items():
    with st.expander(f"âœ¨ {name} ê²Œì‹œíŒ ë³´ê¸°"):
        st.image(img, width=220)
        c1, c2, c3 = st.columns(3)
        with c1: draw_empty_space()
        with c2: draw_empty_space()
        with c3: draw_empty_space()
        
        st.write("---")
        
        u_content = st.text_area("ì´ ì•¨ë²”ì€ ë‹¹ì‹ ì—ê²Œ ì–´ë–¤ ì˜ë¯¸ì¸ê°€ìš”?", key=f"c_{name}", height=150)
        if st.button("ê³µìœ í•˜ê¸°", key=f"b_{name}"):
            if u_content:
                post_data = {
                    "user": st.session_state.user_name,
                    "content": u_content,
                    "date": datetime.now().strftime("%Y-%m-%d %H:%M")
                }
                safe_name = "".join(x for x in name if x.isalnum())
                requests.post(f"{FIREBASE_URL}/reviews/{safe_name}.json", json=post_data)
                st.success("ì†Œì¤‘í•œ ì˜ê²¬ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
                st.rerun()
        
        st.write("**ğŸ’¬ íŒ¬ë“¤ì´ ë‚¨ê¸´ ê¸°ë¡**")
        safe_name = "".join(x for x in name if x.isalnum())
        response = requests.get(f"{FIREBASE_URL}/reviews/{safe_name}.json")
        data = response.json()
        
        if data:
            for key in reversed(list(data.keys())):
                review = data[key]
                st.markdown(f"**ğŸ‘¤ {review['user']}** <small style='color:#bbb'>{review['date']}</small>", unsafe_allow_html=True)
                st.info(review['content'])
        else:
            st.write("ì•„ì§ ë“±ë¡ëœ ì´ì•¼ê¸°ê°€ ì—†ë„¤ìš”. ì²« ë²ˆì§¸ íŒ¬ì´ ë˜ì–´ë³´ì„¸ìš”!")

st.write("---")
st.caption("Â© Swiftie Critics Community | Taylor's Version")
